local Players   = game:GetService("Players")
local player    = Players.LocalPlayer
local char      = player.Character or player.CharacterAdded:Wait()
local hrp       = char:WaitForChild("HumanoidRootPart")
local humanoid  = char:WaitForChild("Humanoid")

local remote    = char:WaitForChild("Steel Pickaxe"):WaitForChild("Events"):WaitForChild("Damage")
local sellCFrame = CFrame.new(0, 10, 0)

local damaged = false
humanoid.HealthChanged:Connect(function(h)
    if h < humanoid.MaxHealth then
        damaged = true
    end
end)

local function getIronParts()
    local list = {}
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") and part.Name == "Iron" then
            table.insert(list, part)
        end
    end
    return list
end

local function activatePrompt(part)
    for _, obj in ipairs(part:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            obj:InputHoldBegin()
            wait(0.1)
            obj:InputHoldEnd()
            return true
        end
    end
    return false
end

local function mineNode(node)
    for i = 1, 4 do
        if damaged then
            hrp.CFrame = sellCFrame
            return true
        end

        -- Teleport to iron node
        hrp.CFrame = node.CFrame + Vector3.new(0, 3, 0)
        wait(0.2)

        -- Fire the remote with only one arg now
        local args = {
            workspace:WaitForChild("Iron"):WaitForChild("Iron"):WaitForChild("Rock")
        }
        remote:FireServer(unpack(args))
        wait(0.3)

        -- Try to pick up dropped iron
        local dropped
        local drops = workspace:FindFirstChild("DroppedMaterials")
        if drops then
            for _, d in ipairs(drops:GetChildren()) do
                if d.Name == "Iron" and (d.Position - hrp.Position).Magnitude < 10 then
                    dropped = d
                    break
                end
            end
        end

        if dropped then
            hrp.CFrame = dropped.CFrame + Vector3.new(0, 3, 0)
            wait(0.2)
            activatePrompt(dropped)
        end

        wait(0.5)
    end
    return false
end

local function main()
    for _, node in ipairs(getIronParts()) do
        if mineNode(node) then break end
    end
    hrp.CFrame = sellCFrame
    print("Mining done â€” teleported to sell.")
end

main()
